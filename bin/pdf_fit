#!/usr/bin/env php
<?php

foreach ([
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../autoload.php',
] as $autoload) {
    if (file_exists($autoload)) {
        require $autoload;
        break;
    }
}
declare(strict_types=1);

require __DIR__ . '/../autoload.php';

use PdfFit\Api\Server;
use PdfFit\Batch\BatchProcessor;
use PdfFit\Cli\ArgvParser;
use PdfFit\Core\Logger;
use PdfFit\Core\Pipeline;

$parser = new ArgvParser();

try {
    [$command, $target, $options] = $parser->parse($argv);
} catch (\InvalidArgumentException $exception) {
    fwrite(STDERR, $exception->getMessage() . "\n");
    exit(1);
}

$command = strtolower($command);

switch ($command) {
    case 'batch':
        if ($target === null) {
            fwrite(STDERR, "Batch mode requires a directory.\n");
            exit(1);
        }
        $mode = $options['mode'] ?? 'smart';
        unset($options['mode']);

        $mode = $options['mode'] ?? 'smart';
        unset($options['mode']);

        $results = BatchProcessor::runDirectory($target, $mode, $options);
        Logger::printBatchSummary($results);
        exit(0);

    case 'server':
        $host = $options['host'] ?? '0.0.0.0';
        $port = (int) ($options['port'] ?? 8080);
        $docRoot = $target;

        Server::run($host, $port, $docRoot);
        exit(0);

    default:
        if ($target === null) {
            fwrite(STDERR, "Command {$command} requires a target file.\n");
            exit(1);
        }

        $pipeline = new Pipeline($command, $target, $options);
        $result = $pipeline->run();
        Logger::printSummary($result);
        exit(0);
}
